<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust Wasm Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom styling for the calculator display */
        #display {
            min-height: 2.5rem;
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        /* Base button styles applied to all calculator buttons */
        .calc-btn {
            @apply font-semibold py-3 rounded-xl transition duration-150 ease-in-out shadow-md active:shadow-inner;
        }
        /* Default colors for number/clear/delete buttons */
        .calc-btn[data-type="number"], .calc-btn[data-type="delete"], .calc-btn[data-type="clear"] {
             @apply bg-gray-200 hover:bg-gray-300 text-gray-800;
        }
        /* Specific overrides for color-coded buttons */
        .calc-btn[data-type="equals"] {
            @apply bg-indigo-600 text-white hover:bg-indigo-700;
        }
        .calc-btn[data-type="operator"] {
             @apply text-indigo-600 bg-gray-200 hover:bg-indigo-100;
        }
        .calc-btn[data-type="delete"] {
             @apply bg-red-500 text-white hover:bg-red-600;
        }
        .calc-btn[data-type="clear"] {
             @apply bg-yellow-500 text-white hover:bg-yellow-600;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">
    <div id="app" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full border-t-4 border-indigo-600">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">Wasm Calculator</h1>
        <p class="text-sm text-indigo-500 mb-6">Logic powered by Rust ðŸ¦€</p>

        <!-- Display Area -->
        <div id="display" class="bg-gray-100 text-right p-4 mb-4 rounded-lg text-3xl font-mono overflow-x-auto whitespace-nowrap text-gray-800 shadow-inner">
            0
        </div>

        <!-- Calculator Buttons -->
        <div class="calculator-grid">
            <!-- First Row -->
            <button class="calc-btn" data-type="clear">C</button>
            <button class="calc-btn" data-type="operator" data-op="/">Ã·</button>
            <button class="calc-btn" data-type="operator" data-op="*">Ã—</button>
            <button class="calc-btn" data-type="delete">DEL</button>
            
            <!-- Number Rows -->
            <button class="calc-btn" data-type="number" data-value="7">7</button>
            <button class="calc-btn" data-type="number" data-value="8">8</button>
            <button class="calc-btn" data-type="number" data-value="9">9</button>
            <button class="calc-btn" data-type="operator" data-op="-">-</button>
            
            <button class="calc-btn" data-type="number" data-value="4">4</button>
            <button class="calc-btn" data-type="number" data-value="5">5</button>
            <button class="calc-btn" data-type="number" data-value="6">6</button>
            <button class="calc-btn" data-type="operator" data-op="+">+</button>

            <button class="calc-btn" data-type="number" data-value="1">1</button>
            <button class="calc-btn" data-type="number" data-value="2">2</button>
            <button class="calc-btn" data-type="number" data-value="3">3</button>
            <button class="calc-btn col-span-1" data-type="equals">=</button>
            
            <!-- Bottom Row -->
            <button class="calc-btn col-span-3" data-type="number" data-value="0">0</button>
            <button class="calc-btn" data-type="number" data-value=".">.</button>
        </div>
    </div>

    <!-- JavaScript Logic for Wasm Interaction -->
    <script type="module">
        // Import the Wasm initializer and the exported functions/enums
        import init, { calculate, Operation } from './wasm-calculator/pkg/wasm_calculator.js';

        // --- DOM elements ---
        const display = document.getElementById('display');
        const buttons = document.querySelectorAll('.calc-btn');

        // --- Calculator State ---
        let currentInput = '0';
        let previousValue = null;
        let operation = null;
        let waitingForSecondOperand = true;

        // Map UI operator symbols to Rust enum names exposed by Wasm
        const RustOperation = {
            '+': 'Add',
            '-': 'Subtract',
            '*': 'Multiply',
            '/': 'Divide',
        };

        function updateDisplay(value) {
            // Prevent display overflow for very long numbers
            const formattedValue = value.length > 15 ? parseFloat(value).toPrecision(10) : value;
            display.textContent = formattedValue;
        }

        function clear() {
            currentInput = '0';
            previousValue = null;
            operation = null;
            waitingForSecondOperand = true;
            updateDisplay(currentInput);
        }

        function handleNumber(value) {
            if (waitingForSecondOperand || currentInput === '0') {
                currentInput = value === '.' ? '0.' : value;
                waitingForSecondOperand = false;
            } else if (value === '.' && !currentInput.includes('.')) {
                currentInput += value;
            } else if (value !== '.') {
                currentInput += value;
            }
            updateDisplay(currentInput);
        }

        async function handleOperator(op) {
            if (display.textContent === "Wasm Load Error") return;

            const inputValue = parseFloat(currentInput);

            if (previousValue === null) {
                previousValue = inputValue;
                operation = op;
                waitingForSecondOperand = true;
                currentInput = '0';
                updateDisplay(inputValue.toString());
                return;
            }

            if (operation && !waitingForSecondOperand) {
                // Calculate result using Rust Wasm
                const result = calculate(
                    previousValue, 
                    inputValue, 
                    Operation[RustOperation[operation]] // Pass the Rust enum variant
                );

                previousValue = result;
                operation = op;
                waitingForSecondOperand = true;
                currentInput = '0';
                
                updateDisplay(result.toString());
            } else if (previousValue !== null && op) {
                // Just switch the operator if a new one is pressed
                operation = op;
                updateDisplay(previousValue.toString());
            }
        }

        async function handleEquals() {
            if (previousValue === null || waitingForSecondOperand || operation === null || display.textContent === "Wasm Load Error") return;

            const inputValue = parseFloat(currentInput);

            // Calculate final result using Rust Wasm
            const result = calculate(
                previousValue, 
                inputValue, 
                Operation[RustOperation[operation]] // Pass the Rust enum variant
            );

            // Reset state for next calculation
            currentInput = result.toString();
            previousValue = null;
            operation = null;
            waitingForSecondOperand = true;
            
            updateDisplay(currentInput);
        }

        function handleDelete() {
            if (currentInput.length > 1 && !waitingForSecondOperand) {
                currentInput = currentInput.slice(0, -1);
            } else {
                currentInput = '0';
            }
            waitingForSecondOperand = false;
            updateDisplay(currentInput);
        }

        // --- Event Listener Setup ---
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const type = button.dataset.type;
                const value = button.dataset.value;
                const op = button.dataset.op;

                switch (type) {
                    case 'number':
                        handleNumber(value);
                        break;
                    case 'operator':
                        handleOperator(op);
                        break;
                    case 'equals':
                        handleEquals();
                        break;
                    case 'clear':
                        clear();
                        break;
                    case 'delete':
                        handleDelete();
                        break;
                }
            });
        });
        
        // --- Wasm Initialization ---
        // We call the init function to load the WASM binary asynchronously.
        init('./wasm-calculator/pkg/wasm_calculator_bg.wasm').then(() => {
            console.log("Wasm module loaded successfully.");
            updateDisplay('0');
        }).catch(e => {
            console.error("WASM Initialization Error:", e);
            display.textContent = "Wasm Load Error";
        });

    </script>
</body>
</html>